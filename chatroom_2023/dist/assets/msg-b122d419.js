var b=Object.defineProperty;var y=(e,t,s)=>t in e?b(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var i=(e,t,s)=>(y(e,typeof t!="symbol"?t+"":t,s),s);import{e as _,f as P,u as x}from"./index-75546a41.js";import{a as T}from"./axios-08622986.js";const p=_("contactPina",{state:()=>({current:{},contacts:[]}),actions:{save_current_by_phone(e){let t={};this.contacts.map(s=>{s.phone_number===e&&(t=s)}),this.current=t},save_current(e){this.current=e||{}},save_contacts(e){this.contacts=e||[]}},getters:{has_current(e){return e.current&&e.current.phone_number}},persist:{enabled:!0,strategies:[{key:"wind_contact",storage:sessionStorage,paths:["contact"]}]}}),g=_("tempPina",{state:()=>({tempiates:[]}),actions:{temp_by_id(e){let t={};return this.tempiates.map(s=>{s.id===e&&(t=s)}),t},buiid_params(e){return e.body_variable_count==2?[{type:"text",text:"测试参数一"},{type:"text",text:"测试参数二"}]:[{type:"text",text:"测试参数一"}]},save_tempiates(e){this.tempiates=e||[]}},getters:{},persist:{enabled:!0,strategies:[{key:"wind_tempiate",storage:sessionStorage,paths:["tempiates"]}]}}),m=T.create({baseURL:"",timeout:1e3*30});m.interceptors.request.use(e=>e,e=>(console.log("request 网络异常 response =",e),Promise.reject(e)));m.interceptors.response.use(e=>e,e=>(console.log("response 网络异常 response =",e),Promise.reject(e)));const k={tempiates:"/whatsapp-templates",contacts:"/contacts",message:"/whatsapp-messages",send:"/send_whatsapp_messages",send_tempiate:"/send_whatsapp_message_template"},v=P.API;class A{uri(t,s=""){return v+k[t]+"/"+s}auth(t){return{Authorization:"Bearer "+t}}headers(t){return t?{"Content-Type":"application/json",...this.auth(t)}:{"Content-Type":"application/json"}}params(t,s="?"){if(JSON.stringify(t)!="{}")for(const n in t)s+=n+"="+t[n]+"&";return s}}class N extends A{async pos(t,s,n,r,o){const a=await m.post(super.uri(t),n,{headers:super.headers(s)});return a&&a.status<399?a.data:!1}put(t,s,n,r,o){throw new Error("Method not implemented.")}async get(t,s,n={},r){return new Promise(o=>{setTimeout(async()=>{const a=super.uri(t,r)+super.params(n);console.log("URI =",a);let h=await m.get(a,{headers:super.headers(s)});o(h&&h.status<399?h.data:!1)},2e3)})}}const u=new N,M=function(e,t=[]){return e?e.data:t},f=function(e){return{id:e.id,...e.attributes}},d=function(e,t=!0){return e=t?M(e):e,e?e.constructor==Array?e.map(s=>f(s)):e?f(e):null:[]},E=function(e,t){return e.map(s=>(t.length>0&&t.map(n=>{s[n]=d(s[n])}),s)),e},I=(e,t=[])=>new Promise(async s=>{const n=d(e);s({data:n?E(n,t):[],page:e.meta?e.meta.pagination:{}})}),j=e=>d(e),l="tempiates",c=()=>x().jwt,S={get:async(e={})=>{const t=await u.get(l,c(),e);return t?await I(t):{}},send:async(e,t,s,n)=>(console.log("發送模板",{lang:e,name:t,recipient:s,components:n}),!!await u.pos("send_tempiate",c(),{name:t,recipient:s,components:n},"",{lang:e})),pos:async e=>(await u.pos(l,c(),{data:e}),{}),one:async e=>{const t=await u.get(l,c(),{},e);return t?j(t):{}}},w=(e="TESTING")=>({attached_contacts:null,business_phone_number:"85290617430",business_phone_number_id:"101639509439423",contact:{id:1,profile_name:"Felix Chiu",phone_number:"447516014375",last_conversation_time:"2022-12-08T13:34:06.000Z",free_response_limit:"2022-12-09T13:34:06.000Z"},context:null,createdAt:"2022-11-23T22:44:24.675Z",dateTime:"2022-11-23T22:44:23.000Z",delivered_time:null,direction:"receive",error:null,id:51,isDelivered:null,isRead:null,isShow:!0,last_message_relation:{data:null},last_message_whatsapp_id:null,media:null,media_detail:null,message:e,phone_number:"447516014375",publishedAt:"2022-11-23T22:44:24.667Z",raw:[{}],read_time:null,send_detail:null,status:null,timestamp:"1669243463",type:"text",updatedAt:"2022-11-23T22:44:24.675Z",whatsapp_message_id:"wamid.HBgMNDQ3NTE2MDE0Mzc1FQIAEhgUM0FDNzI3QkNFQjU2QTExRTk4RUMA",whatsapp_profile:"Felix Chiu"});class D{constructor(){i(this,"msgs",{});i(this,"speed",8*1e3);i(this,"interv",0);i(this,"iock",!1);i(this,"aiiow",!0);this.init()}init(){return new Promise(t=>{this.fetch(),console.log("MANAGER 創建"),this.interv=setInterval(()=>{this.fetch()},this.speed),t(0)})}fetch(t){if(this.aiiow)return this.aiiow=!1,new Promise(async s=>{const n=p().current;this.msgs[n.phone_number]||(this.msgs[n.phone_number]=[]),this.iock||(this.iock=!0,this.msgs[n.phone_number].push(w("測試消息")),this.refresh(),this.iock=!1),this.aiiow=!0})}say(t,s){return new Promise(n=>{this.msgs[t].push(w(s)),this.iock||this.refresh(),n(0)})}send_tempiate(t,s,n){return new Promise(async r=>{const o=t.name,a=t.language;r(await S.send(a,o,s,n))})}refresh(){R().save_msgs(this.msgs)}}const R=_("msgPina",{state:()=>({msgs:{},index:0,manager:{}}),actions:{init(){return new Promise(e=>{this.manager=new D,e(0)})},save_msgs(e){this.msgs=e,this.index+=1,console.log("平替更新 =",this.msgs)},save_msg(e){e&&e.phone_number&&(this.msgs[e.phone_number]=e)},say(e){const t=p().current;this.manager.say(t.phone_number,e)},async send_tempiate(e){const t=g().temp_by_id(e),s=p().current;return await this.manager.send_tempiate(t,s.phone_number,[{type:"BODY",parameters:g().buiid_params(t)}])}},getters:{current(e){const s=p().current.phone_number;return e.msgs[s]}},persist:{enabled:!0,strategies:[{key:"wind_contact",storage:sessionStorage,paths:[""]}]}});export{j as a,S as b,p as c,R as m,u as n,I as s,g as t};
